# Toy-vs-Shoe I0 Runbook

## Scope
Iteration-0 builds a safety-biased binary detector (`toy`, `shoe`) and ROS2 safety gate.

## Non-Negotiables
- CVAT is labeling-only. Ignore CVAT split artifacts (`train.txt`, `val.txt`, `valid.txt`, `test.txt`, `data.yaml`) from exports.
- Train/val/test split must be generated by `prepare_dataset_split.py` with session separation.
- Critical shoe->toy error requires spatial correspondence in pickup zone: `IoU >= 0.3 OR predicted toy center in GT shoe box`.
- Runtime detector topic must publish `vision_msgs/msg/Detection2DArray` on `/perception/detections_2d`.
- Training must use fixed seed + deterministic mode.

## I0 Targets
- Data: 12 sessions (`toy_only x3`, `shoe_only x3`, `mixed_clutter x4`, `empty_floor x2`), >=2 lighting IDs, >=4 backgrounds.
- Labels: <=500 instances/class.
- Acceptance:
  - mixed-clutter toy recall >= 0.70
  - pickup-risk critical shoe->toy error rate < 0.05
- Deployment export: TensorRT engine with `imgsz=640`, `half=True`, `dynamic=False`, `batch=1`, `nms=True`.

## Required Inputs
- Labels schema: `docs/perception/cvat_labels_toy_shoe.json` (`toy`, `shoe` only).
- Capture plan/status: `docs/perception/i0_capture_manifest.csv`.
- Report template: `docs/perception/i0_report_template.md`.

## Pipeline Commands
1. Deterministic rosbag extraction:
```bash
python3 ros_ws/src/perception/toy_shoe_perception/scripts/extract_rosbag_images.py \
  --bags-dir ros_ws/src/perception/toy_shoe_perception/data/raw_bags \
  --out-dir ros_ws/src/perception/toy_shoe_perception/dataset/extracted \
  --fps 2.0 --seed 42
```
Expected outputs:
- `ros_ws/src/perception/toy_shoe_perception/dataset/extracted/session_index.json`
- `.../dataset/extracted/sessions/<session_id>/meta.json` with `selected_frame_checksum_sha256`

2. CVAT labeling:
- Create CVAT tasks from extracted frames.
- Use only labels `toy` and `shoe`.
- Export each task/session as Ultralytics YOLO `.zip`.

3. Import and merge CVAT exports (ignore CVAT splits):
```bash
python3 ros_ws/src/perception/toy_shoe_perception/scripts/import_cvat_ultralytics_yolo.py \
  --exports-dir ros_ws/src/perception/toy_shoe_perception/dataset/cvat/exports \
  --session-map ros_ws/src/perception/toy_shoe_perception/dataset/extracted/session_index.json \
  --out-dir ros_ws/src/perception/toy_shoe_perception/dataset/yolo_i0 \
  --strict --clear-existing
```
Expected outputs:
- `.../dataset/yolo_i0/samples.csv`
- `.../dataset/yolo_i0/import_manifest.json`
- `.../dataset/yolo_i0/classes.json`

4. Build deterministic session-separated split:
```bash
python3 ros_ws/src/perception/toy_shoe_perception/scripts/prepare_dataset_split.py \
  --dataset-dir ros_ws/src/perception/toy_shoe_perception/dataset/yolo_i0 \
  --manifest docs/perception/i0_capture_manifest.csv \
  --seed 42
```
Expected outputs:
- `.../dataset/yolo_i0/data.yaml`
- `.../dataset/yolo_i0/split_manifest.json` (`no_session_overlap: true`)
- `.../dataset/yolo_i0/split_assignments.csv`

5. Reproducible training:
```bash
python3 ros_ws/src/perception/toy_shoe_perception/scripts/train_yolo.py \
  --dataset-dir ros_ws/src/perception/toy_shoe_perception/dataset/yolo_i0 \
  --out-dir ros_ws/src/perception/toy_shoe_perception/artifacts/train_i0 \
  --seed 42 --deterministic --epochs 50 --imgsz 640 --batch 16
```
Expected outputs:
- `.../artifacts/train_i0/run_manifest.json` (Ultralytics version, seed, deterministic, git commit, dataset version id)
- weights under `.../artifacts/train_i0/runs/toy_shoe_i0/weights/`

6. Safety-first evaluation:
```bash
python3 ros_ws/src/perception/toy_shoe_perception/scripts/evaluate_toy_shoe.py \
  --pred-dir ros_ws/src/perception/toy_shoe_perception/artifacts/train_i0/preds \
  --gt-dir ros_ws/src/perception/toy_shoe_perception/dataset/yolo_i0/labels/test \
  --out-dir ros_ws/src/perception/toy_shoe_perception/artifacts/eval_i0 \
  --capture-manifest docs/perception/i0_capture_manifest.csv \
  --pickup-zone 0.30,0.20,0.95,0.98 \
  --critical-iou-thresh 0.3 \
  --target-toy-recall 0.70 \
  --target-critical-rate 0.05
```
Expected outputs:
- `.../artifacts/eval_i0/metrics.json`
- `.../artifacts/eval_i0/confusion.csv`
- `.../artifacts/eval_i0/critical_error_report.json` (includes unsafe frame paths + thresholds)

7. Hard-frame mining:
```bash
python3 ros_ws/src/perception/toy_shoe_perception/scripts/mine_hard_frames.py \
  --critical-report ros_ws/src/perception/toy_shoe_perception/artifacts/eval_i0/critical_error_report.json \
  --out ros_ws/src/perception/toy_shoe_perception/artifacts/eval_i0/hard_frames.txt \
  --top-k 200
```
Expected outputs:
- `.../artifacts/eval_i0/hard_frames.txt`
- `.../artifacts/eval_i0/hard_frame_summary.json`

8. Export TensorRT on target Jetson:
```bash
python3 ros_ws/src/perception/toy_shoe_perception/scripts/export_tensorrt.py \
  --weights ros_ws/src/perception/toy_shoe_perception/artifacts/train_i0/runs/toy_shoe_i0/weights/best.pt \
  --out-dir ros_ws/src/perception/toy_shoe_perception/artifacts/export_i0 \
  --imgsz 640 --half --no-dynamic --batch 1 --nms
```
Expected outputs:
- `.../artifacts/export_i0/export_manifest.json`
- TensorRT engine path recorded in manifest (`engine_path`)
- Note: engine must be produced on the deployment Jetson

9. ROS2 runtime launch:
```bash
ros2 launch toy_shoe_perception toy_shoe_i0.launch.py \
  model_engine_path:=/absolute/path/to/model.engine
```
Expected runtime topics:
- `/perception/detections_2d` (`vision_msgs/msg/Detection2DArray`)
- `/perception/toy_candidates` (`vision_msgs/msg/Detection2DArray`)
- `/perception/shoe_blocked` (`std_msgs/msg/Bool`)

Quick checks:
```bash
ros2 topic info /perception/detections_2d
ros2 topic info /perception/toy_candidates
ros2 topic echo /perception/shoe_blocked
```

## Go/No-Go and Prescription
- GO when:
  - `metrics.json.toy_recall_mixed_clutter >= 0.70`
  - `metrics.json.critical_error.rate < 0.05`
- NO-GO action:
  - Use `critical_error_report.json` + `hard_frames.txt` for relabeling queue.
  - Follow `next_data_prescription.minimum_additional_sessions` and recommendations in evaluator output.

## Failure Modes and Troubleshooting
- `No rosbag session folders with metadata.yaml`:
  - Verify rosbag2 directory layout under `data/raw_bags`.
- Import errors due class mismatch:
  - Confirm CVAT labels are exactly `toy`, `shoe` and re-export tasks.
- `no_session_overlap: false` in split manifest:
  - Regenerate splits with a single canonical `samples.csv` and fixed seed.
- Training nondeterminism concerns:
  - Keep `--seed` fixed and `--deterministic` enabled.
- Critical metric too high:
  - Inspect `critical_error_report.json` for unsafe frames and collect targeted pickup-risk sessions before retrain.
- Runtime detector publishes empty arrays:
  - Check `model_engine_path`, engine compatibility (built on same Jetson stack), and image topic/encoding.
- Safety gate not blocking:
  - Validate `pickup_zone_xyxy_norm`, `input_width/input_height`, and `shoe_block_debounce_hits` / `shoe_block_hold_sec`.
